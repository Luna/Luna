from Standard.Base import all

from Standard.Test import all
import Standard.Test.Test_Environment

from enso_dev.Base_Tests.Network.Http.Http_Test_Setup import base_url_with_slash, pending_has_url

main filter=Nothing =
    suite = Test.build suite_builder->
        add_specs suite_builder
    suite.run_with_filter filter


with_test_file f ~action =
    f.delete_if_exists
    Panic.with_finalizer (f.delete_if_exists) <|
        action f

add_specs suite_builder =
    suite_builder.group "Download Mode" pending=pending_has_url group_builder->
        url_n_bytes n = base_url_with_slash+'test_download?length='+n.to_text

        group_builder.specify "Will always download a file for mode Always" <|
            with_test_file (enso_project.data / "transient" / "if_not_exist.txt") file->
                file.exists . should_be_false
                Data.download (url_n_bytes 10) mode=..If_Not_Exists file
                first_contents = file.read
                Data.download (url_n_bytes 11) mode=..If_Not_Exists file
                second_contents = file.read
                first_contents . should_not_equal second_contents

        group_builder.specify "Will download a file if it does not exist for mode If_Not_Exists" <|
            with_test_file (enso_project.data / "transient" / "if_not_exist.txt") file->
                file.exists . should_be_false
                Data.download (url_n_bytes 10) mode=..If_Not_Exists file
                first_contents = file.read
                Data.download (url_n_bytes 11) mode=..If_Not_Exists file
                second_contents = file.read
                first_contents . should_equal second_contents

        group_builder.specify "Will download a file if it is older than a specified duration for mode If_Older_Than" <|
            with_test_file (enso_project.data / "transient" / "if_older_than.txt") file->
                file.exists . should_be_false

                Data.download (url_n_bytes 10) file
                first_contents = file.read

                Data.download (url_n_bytes 11) (mode=..If_Older_Than (Duration.new seconds=1000) file
                second_contents = file.read
                first_contents . should_equal second_contents

                file.set_last_modified_time (file.get_last_modified_time + (Duration.new seconds=1000))

                Data.download (url_n_bytes 12) (mode=..If_Older_Than (Duration.new seconds=1000) file
                third_contents = file.read
                first_contents . should_not_equal third_contents
