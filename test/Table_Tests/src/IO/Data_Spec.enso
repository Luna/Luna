from Standard.Base import all

from Standard.Test import all
import Standard.Test.Test_Environment

from enso_dev.Base_Tests.Network.Http.Http_Test_Setup import base_url_with_slash, pending_has_url

main filter=Nothing =
    suite = Test.build suite_builder->
        add_specs suite_builder
    suite.run_with_filter filter


with_test_file f ~action =
    Panic.with_finalizer (f.delete_if_exists)
        action f

add_specs suite_builder =
    suite_builder.group "Download Mode" pending=pending_has_url group_builder->
        url_n_bytes n = base_url_with_slash+'test_download?length='+n.to_text

        group_builder.specify "Will download a file if it does not exist" <|
            with_test_file (enso_project.data / "transient" / "if_not_exist.txt") file->
                file.exists . should_be_false
                Data.download (url_n_bytes 10) file
                first_contents = file.read
                Data.download (url_n_bytes 11) file
                second_contents = file.read
                first_contents . should_equal second_contents
