from Standard.Base import all

import Standard.Base.Errors.Illegal_Argument.Illegal_Argument
import Standard.Base.Network.HTTP.Request_Body.Request_Body
import Standard.Base.Network.HTTP.Post_Request_Body.Post_Request_Body

from Standard.Test import Test, Test_Suite
import Standard.Test.Extensions

polyglot java import java.lang.System as Java_System

type Test_Type
    Aaa (s:Text)
    Bbb (i:Integer)

type Bad_To_Json
    Aaa (s:Text)
    to_json self = JS_Object.from_pairs [Pair.new [] 0]

spec =
    base_url = Java_System.getenv "ENSO_HTTP_TEST_HTTPBIN_URL"
    pending_has_url = if base_url != Nothing then Nothing else
        "The POST tests only run when the `ENSO_HTTP_TEST_HTTPBIN_URL` environment variable is set to URL of the httpbin server"

    Test.group "asdfasdf" pending=pending_has_url <|
        base_url_with_slash = if base_url.ends_with "/" then base_url else base_url + "/"
        url_post = base_url_with_slash + "post"

        Test.specify "Can perform a Post_Request_Body.Text POST" <|
            response = Data.post url_post (Post_Request_Body.Text "hello world")
            response.at "data" . should_equal "hello world"
            response.at "headers" . at "Content-Length" . should_equal "11"
            response.at "headers" . at "Content-Type" . should_equal "text/plain"

        Test.specify "Can perform a Text POST" <|
            response = Data.post url_post "hello world"
            response.at "data" . should_equal "hello world"
            response.at "headers" . at "Content-Length" . should_equal "11"
            response.at "headers" . at "Content-Type" . should_equal "text/plain"

        Test.specify "Can perform a Post_Request_Body.Json POST" <|
            response = Data.post url_post (Post_Request_Body.Json (Test_Type.Aaa "abc"))
            response.at "data" . should_equal '{"type":"Test_Type","constructor":"Aaa","s":"abc"}'
            response.at "headers" . at "Content-Length" . should_equal "50"
            response.at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "Can perform am object JSON POST" <|
            response = Data.post url_post (Test_Type.Bbb 12)
            response.at "data" . should_equal '{"type":"Test_Type","constructor":"Bbb","i":12}'
            response.at "headers" . at "Content-Length" . should_equal "47"
            response.at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "can handle a bad .to_json" <|
            Data.post url_post (Bad_To_Json.Aaa "abcd") . should_fail_with Illegal_Argument

    Test.group "old post" pending=pending_has_url <|
        base_url_with_slash = if base_url.ends_with "/" then base_url else base_url + "/"
        url_post = base_url_with_slash + "post"

        Test.specify "Can perform a Text POST" <|
            response = Data.old_post url_post "hello world"
            response.at "data" . should_equal "hello world"
            response.at "headers" . at "Content-Length" . should_equal "11"
            response.at "headers" . at "Content-Type" . should_equal "text/plain"

        Test.specify "Can perform a Json POST" <|
            response = Data.old_post url_post '{ "a" : 1 }' mime_type="application/json"
            response.at "data" . should_equal '{ "a" : 1 }'
            response.at "headers" . at "Content-Length" . should_equal "11"
            response.at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "Can perform an object .to_json POST" <|
            response = Data.old_post url_post (Test_Type.Aaa "abcd")
            response.at "data" . should_equal '{"type":"Test_Type","constructor":"Aaa","s":"abcd"}'
            response.at "headers" . at "Content-Length" . should_equal "50"
            response.at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "Can perform an object Request_Body.Text POST" <|
            response = Data.old_post url_post (Request_Body.Text "abcd")
            response.at "data" . should_equal 'abcd'
            response.at "headers" . at "Content-Length" . should_equal "4"
            response.at "headers" . at "Content-Type" . should_equal "text/plain"

        Test.specify "Can perform an object Request_Body.Json POST" <|
            response = Data.old_post url_post (Request_Body.Json '{ "a" : 1 }')
            response.at "data" . should_equal '{ "a" : 1 }'
            response.at "headers" . at "Content-Length" . should_equal "11"
            response.at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "Can perform a File POST" <|
            test_file = enso_project.data / "sample.txt"
            returned_file = Data.old_post url_post test_file . at "data"
            returned_file.should_equal test_file.read_text

        Test.specify "Can perform a binary File POST" <|
            test_file = enso_project.data / "sample.png"
            response = Data.old_post_file_as_form url_post test_file "imageFile" headers=[Header.multipart_form_data]
            response.at "files" . at "imageFile" . should_start_with "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJgAA"

        Test.specify "Can perform a File POST via form" <|
            test_file = enso_project.data / "sample.txt"
            Data.old_post_file_as_form url_post test_file "fn" . at "data" . should_contain "fn=Cupcake+ipsum+dolor+sit+amet"

        Test.specify "Uses the correct mime type" <|
            body = '{ "a" : 1 }'
            Data.old_post url_post body . at "headers" . at "Content-Type" . should_equal "text/plain"
            Data.old_post url_post body mime_type="text/plain" . at "headers" . at "Content-Type" . should_equal "text/plain"
            Data.old_post url_post body mime_type="application/json" . at "headers" . at "Content-Type" . should_equal "application/json"
            Data.old_post url_post (Test_Type.Aaa "abcd") . at "headers" . at "Content-Type" . should_equal "application/json"
            Data.old_post url_post (Test_Type.Bbb 123) . at "headers" . at "Content-Type" . should_equal "application/json"
            Data.old_post url_post (Request_Body.Text "abcd") . at "headers" . at "Content-Type" . should_equal "text/plain"
            Data.old_post url_post (Request_Body.Json '{ "a" : 1 }') . at "headers" . at "Content-Type" . should_equal "application/json"

        Test.specify "can handle a bad .to_json" <|
            Data.old_post url_post (Bad_To_Json.Aaa "abcd") . should_fail_with Illegal_Argument

main = Test_Suite.run_main spec
