from Standard.Base import all
import Standard.Base.Data.Array_Proxy.Array_Proxy
import Standard.Base.Errors.Common.Missing_Argument
import Standard.Base.Metadata.Display
from Standard.Base.Metadata import Choice, make_single_choice, Widget
from Standard.Base.Metadata.Choice import Option
from Standard.Base.Metadata.Widget import Single_Choice, Text_Input, Vector_Editor

from Standard.Table import Table
import Standard.Table.Rows_To_Read.Rows_To_Read

import project.Google_Credential.Google_Credential
import project.Google_Analytics_Account.Google_Analytics_Account
import project.Google_Analytics_Account.Google_Analytics_Account_Filter
import project.Google_Analytics_Property.Google_Analytics_Property
from project.Internal.Google_Analytics_Internal import all

polyglot java import org.enso.google.GoogleAnalyticsReader

type Google_Analytics
    ## GROUP Standard.Base.Input
       ICON data_input
       Performs google analytics call
       This method calls the google reporting v4 api.

       Arguments:
       - property_id: The Google Analytics property_id that is being queried
       - start_date: The beginning date of the query. Default is 2020-03-31
       - end_date: The end date being queried. Defaults to today.
    @property_id Google_Analytics_Property.default_widget
    @dimensions _make_dimensions_vector_selector
    @metrics _make_metrics_vector_selector
    @credentials Google_Credential.default_widget
    @start_date _make_start_date_widget
    @end_date (Date.default_widget include_today=True)
    read : Text -> (Vector Text) -> (Vector Text) -> Date -> Date -> Google_Credential -> Table
    read property_id:Google_Analytics_Property=(Missing_Argument.throw "property_id") dimensions:Vector=['country'] metrics:Vector=['activeUsers'] start_date:Date=(Date.today.previous ..Year) end_date:Date=Date.today credentials:Google_Credential=..Default -> Table =
        case credentials of
            Google_Credential.Sample -> read_sample_data dimensions metrics start_date end_date
            _ -> read_api_data property_id.id dimensions metrics start_date end_date credentials

    ## ICON data_input
       Reads the set of accounts from Google Analytics Admin API.

       Arguments:
       - credentials: The Google credentials to use. Default is the default
         credentials.
       - limit: The maximum number of accounts to read. Default is 1000.
       - include_deleted: Whether to include deleted accounts. Default is false.
    @credentials Google_Credential.default_widget
    @limit Rows_To_Read.default_widget
    list_accounts : Google_Credential -> Rows_To_Read -> Boolean -> Vector
    list_accounts credentials:Google_Credential=..Default (limit : Rows_To_Read = ..First_With_Warning 1000) include_deleted:Boolean=False -> Vector =
        java_credentials = credentials.as_java
        to_read = limit.rows_to_read.if_nothing 0
        array = GoogleAnalyticsReader.listAccounts java_credentials to_read include_deleted
        vector = array.map a-> Google_Analytics_Account.Value a
        limit.attach_warning_vector vector

    ## ICON data_input
       Reads the set of properties from Google Analytics Admin API.

       Arguments:
       - credentials: The Google credentials to use. Default is the default
         credentials.
       - limit: The maximum number of accounts to read. Default is 1000.
       - include_deleted: Whether to include deleted accounts. Default is false.
    @credentials Google_Credential.default_widget
    @limit Rows_To_Read.default_widget
    list_properties : Google_Analytics_Account_Filter -> Google_Credential -> Rows_To_Read -> Boolean -> Vector
    list_properties account:Google_Analytics_Account_Filter=..All_Accounts credentials:Google_Credential=..Default (limit : Rows_To_Read = ..First_With_Warning 1000) include_deleted:Boolean=False -> Vector =
        java_credentials = credentials.as_java
        to_read = limit.rows_to_read.if_nothing 0
        filter = account.as_java
        array = GoogleAnalyticsReader.listProperties java_credentials filter to_read include_deleted
        vector = array.map a-> Google_Analytics_Property.Value a
        limit.attach_warning_vector vector

## PRIVATE
_make_dimensions_vector_selector : Widget
private _make_dimensions_vector_selector =
    item_editor = make_single_choice ['country', 'date', 'isConversionEvent', 'language', 'userAgeBracket', 'userGender']
    Vector_Editor item_editor=item_editor item_default=item_editor.values.first.value display=Display.Always

## PRIVATE
_make_metrics_vector_selector : Widget
private _make_metrics_vector_selector =
    item_editor = make_single_choice ['activeUsers', 'bounceRate', 'conversions', 'newUsers', 'sessionsPerUser', 'userConversionRate']
    Vector_Editor item_editor=item_editor item_default=item_editor.values.first.value display=Display.Always

## PRIVATE
_make_start_date_widget : Widget
private _make_start_date_widget =
    options = [Option "<Fixed Date>" "Date.new", Option "<Today>" "Date.today", Option "<Start of Period>" "Date.today.previous"]
    Widget.Single_Choice values=options display=Display.When_Modified
