from Standard.Base import all

from Standard.Table import Table

polyglot java import com.google.api.client.googleapis.auth.oauth2.GoogleCredential
polyglot java import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport
polyglot java import com.google.api.client.json.gson.GsonFactory
polyglot java import com.google.api.services.sheets.v4.Sheets
polyglot java import com.google.api.services.sheets.v4.SheetsScopes
polyglot java import java.util.Collections
polyglot java import com.google.analytics.data.v1beta.BetaAnalyticsDataClient
polyglot java import com.google.analytics.data.v1beta.DateRange
polyglot java import com.google.analytics.data.v1beta.Dimension
polyglot java import com.google.analytics.data.v1beta.Metric
polyglot java import com.google.analytics.data.v1beta.Row
polyglot java import com.google.analytics.data.v1beta.RunReportRequest
polyglot java import com.google.analytics.data.v1beta.RunReportResponse


## PRIVATE
type Google_Api_Client
    ## PRIVATE
    Value credential json_factory http_transport

    ## Accesses a service responsible for working with Google Spreadsheets.

       Arguments:
       - app_name: the application name to use for making the API calls. This
         will show up in access logs etc.
    spreadsheets : Text -> Spreadsheets
    spreadsheets self app_name='Enso' =
        service = Sheets.Builder.new self.http_transport self.json_factory self.credential . setApplicationName app_name . build
        Spreadsheets.Service service

## PRIVATE
type Spreadsheets
    ## PRIVATE
    Service java_service

    ## Gets a table with the given ID and sheet range.

       Arguments:
       - sheet_id: the ID of the downloaded spreadsheet. It can be read from the
         spreadsheet URL.
       - sheet_range: specifies the sheet and cell range to read, e.g.
         `'Sheet1!A1:B7'`.
    get_table : Text -> Text -> Table
    get_table self sheet_id sheet_range =
        request = self.java_service.spreadsheets.values.get sheet_id sheet_range . setMajorDimension 'COLUMNS' . setValueRenderOption 'UNFORMATTED_VALUE'
        response = request.execute
        values = Vector.from_polyglot_array response.getValues
        columned = values.map v-> [v.first, v.drop 1]
        Table.new columned

## Initializes the Google services instance using the given credentials file.

   Arguments:
   - secret_file: a file containing Google Service Account credentials to use to
     access Google services. The credentials file can be downloaded from the
     Google Admin Console when generating a key.
initialize : File -> Google_Api_Client
initialize secret_file =
    credential = secret_file.with_input_stream [File_Access.Read] stream->
        stream.with_java_stream is->
            GoogleCredential.fromStream is . createScoped (Collections.singleton SheetsScopes.SPREADSHEETS)
    http_transport = GoogleNetHttpTransport.newTrustedTransport
    json_factory = GsonFactory.getDefaultInstance
    Google_Api_Client.Value credential json_factory http_transport


## PLACEHOLDER, performs google analytics call

   Arguments:
   - property_id
   - start_date
   - end_date
run_google_report : Text -> Text -> Text -> Table
run_google_report self property_id start_date end_date =
    analytics_data = BetaAnalyticsDataClient.create
    request = RunReportRequest.newBuilder
          .setProperty("properties/" + '415432269')
          .addDimensions(Dimension.newBuilder.setName("city"))
          .addMetrics(Metric.newBuilder.setName("activeUsers"))
          .addDateRanges(DateRange.newBuilder.setStartDate("2020-03-31").setEndDate("today"))
          .build
    response = RunReportResponse analytics_data.runReport(request)
    Table.new response.GetRowsList
