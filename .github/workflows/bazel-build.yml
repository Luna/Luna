name: Bazel build
on:
  push:
    branches:
      - develop
  pull_request: {}
jobs:
  build-gui:
    name: Run bazel GUI build
    # if: github.ref != 'refs/heads/develop'
    runs-on:
      - ubuntu-latest
    steps:
      - uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: true
          repository-cache: true
      - uses: actions/checkout@v4
      - run: bazel build //app/gui:dist
        env:
          ENSO_CLOUD_API_URL: ${{ vars.ENSO_CLOUD_API_URL }}
          ENSO_CLOUD_CHAT_URL: ${{ vars.ENSO_CLOUD_CHAT_URL }}
          ENSO_CLOUD_COGNITO_DOMAIN: ${{ vars.ENSO_CLOUD_COGNITO_DOMAIN }}
          ENSO_CLOUD_COGNITO_REGION: ${{ vars.ENSO_CLOUD_COGNITO_REGION }}
          ENSO_CLOUD_COGNITO_USER_POOL_ID: ${{ vars.ENSO_CLOUD_COGNITO_USER_POOL_ID }}
          ENSO_CLOUD_COGNITO_USER_POOL_WEB_CLIENT_ID: ${{ vars.ENSO_CLOUD_COGNITO_USER_POOL_WEB_CLIENT_ID }}
          ENSO_CLOUD_ENVIRONMENT: ${{ vars.ENSO_CLOUD_ENVIRONMENT }}
          ENSO_CLOUD_GOOGLE_ANALYTICS_TAG: ${{ vars.ENSO_CLOUD_GOOGLE_ANALYTICS_TAG }}
          ENSO_CLOUD_SENTRY_DSN: ${{ vars.ENSO_CLOUD_SENTRY_DSN }}
          ENSO_CLOUD_STRIPE_KEY: ${{ vars.ENSO_CLOUD_STRIPE_KEY }}
          VITE_ENSO_AG_GRID_LICENSE_KEY: ${{ vars.ENSO_AG_GRID_LICENSE_KEY }}
          VITE_ENSO_MAPBOX_API_TOKEN: ${{ vars.ENSO_MAPBOX_API_TOKEN }}
      - name: Get build output location
        run: |
          OUTPUT_SYMLINK=$(bazel cquery --output=files //app/gui:dist)
          BAZEL_OUTPUT=$(readlink -f "$OUTPUT_SYMLINK")
          echo "BAZEL_OUTPUT=$BAZEL_OUTPUT" >> $GITHUB_ENV
      - uses: actions/upload-artifact@v4
        with:
          name: gui-static
          path: ${{ env.BAZEL_OUTPUT }}
          if-no-files-found: error
